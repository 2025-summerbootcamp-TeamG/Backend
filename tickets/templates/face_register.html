<!DOCTYPE html>
<html>
<head>
    <title>ì–¼êµ´ ë“±ë¡ ì‹œìŠ¤í…œ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f6fa; }
        .container { max-width: 420px; min-width: 0; width: 100%; box-sizing: border-box; margin: 32px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.07); padding: 22px 24px 18px 24px; }
        h1 { text-align: center; margin-bottom: 24px; font-size: 1.5em; color: #222; letter-spacing: 1px; }
        .section { margin-bottom: 28px; }
        @media (max-width: 600px) {
            .container { max-width: 98vw; padding: 12px 2vw 10px 2vw; }
            h1 { font-size: 1.15em; }
            .section-title { font-size: 1em; }
        }
        .section-title { display: flex; align-items: center; font-size: 1.08em; font-weight: 600; color: #2d3a4a; margin-bottom: 10px; gap: 7px; }
        .section-title .icon { font-size: 1.15em; }
        .camera { text-align: center; margin-bottom: 10px; }
        #video { width: 100%; max-width: 320px; min-width: 180px; border-radius: 8px; border: 1.5px solid #e0e0e0; }
        .btn { padding: 8px 0.9em; min-width: 80px; background: #1976d2; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.15s; }
        .btn:hover { background: #1256a3; }
        .input-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .input-row > * { flex: 1 1 120px; min-width: 0; }
        input[type="text"], input[type="number"], input[type="password"] {
            padding: 8px; border: 1px solid #cfd8dc; border-radius: 4px; width: 100%; font-size: 1em; background: #f8fafc;
            min-width: 0; box-sizing: border-box;
        }
        @media (max-width: 480px) {
            .input-row { flex-direction: column; gap: 6px; }
            .btn { width: 100%; min-width: 0; }
        }
        .result { margin: 16px 0 0 0; padding: 10px; border-radius: 5px; font-size: 0.97em; }
        .success { background: #e3f6e8; color: #256029; }
        .error { background: #ffeaea; color: #b71c1c; }
        ul#face-list { padding-left: 18px; margin-top: 8px; }
        ul#face-list li { margin-bottom: 6px; font-size: 0.96em; }
        .token-box { background: #f1f1f1; padding: 7px; border-radius: 4px; word-break: break-all; margin-top: 6px; }
        .sub-label { font-size: 0.96em; color: #6a7a8c; margin-bottom: 4px; display: block; }
        .center { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ì–¼êµ´ ë“±ë¡ ì‹œìŠ¤í…œ</h1>

        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <!-- [ë¡œê·¸ì¸ í¼] ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë° ë¡œê·¸ì¸ ë²„íŠ¼, ê²°ê³¼ ë©”ì‹œì§€, í† í° ë³µì‚¬ UI -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ”‘</span>ë¡œê·¸ì¸</div>
            <div class="input-row">
                <input type="text" id="login_email" placeholder="ì´ë©”ì¼" />
                <input type="password" id="login_password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
            </div>
            <div class="input-row">
                <button class="btn" onclick="login()">ë¡œê·¸ì¸</button>
            </div>
            <div id="login_result"></div>
            <div id="token_box" class="token-box" style="display:none;"></div>
        </div>

        <!-- íšŒì›ê°€ì… ì„¹ì…˜ -->
        <!-- [íšŒì›ê°€ì… í¼] ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥ ë° íšŒì›ê°€ì… ë²„íŠ¼, ê²°ê³¼ ë©”ì‹œì§€ -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“</span>íšŒì›ê°€ì…</div>
            <div class="input-row">
                <input type="text" id="signup_name" placeholder="ì´ë¦„" />
                <input type="text" id="signup_phone" placeholder="ì „í™”ë²ˆí˜¸" />
            </div>
            <div class="input-row">
                <input type="text" id="signup_email" placeholder="ì´ë©”ì¼" />
                <input type="password" id="signup_password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
                <input type="password" id="signup_password2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" />
            </div>
            <div class="input-row">
                <button class="btn" onclick="signup()">íšŒì›ê°€ì…</button>
            </div>
            <div id="signup_result"></div>
        </div>

        <!-- ì¹´ë©”ë¼ -->
        <!-- [ì¹´ë©”ë¼ ì˜ì—­] ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼, ì–¼êµ´ ê°€ì´ë“œë¼ì¸(íƒ€ì›), ì•ˆë‚´ë¬¸êµ¬, ì¹´ë©”ë¼ ì‹œì‘ ë²„íŠ¼ -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“·</span>ì¹´ë©”ë¼</div>
            <div class="camera" style="position:relative; width:320px; height:240px; margin:0 auto;">
                <video id="video" autoplay style="width:100%; height:100%; border-radius:10px; z-index:1; background:#000;"></video>
                <canvas id="canvas" style="display:none"></canvas>
                <div id="face-guide" style="
                    position:absolute; left:0; top:0; width:100%; height:100%;
                    pointer-events:none; z-index:2;">
                    <svg width="100%" height="100%">
                        <!-- [ê°€ì´ë“œë¼ì¸ íƒ€ì›] ì‹¤ì œ ì¸ì‹ íƒ€ì›ë³´ë‹¤ ë„“ê²Œ í‘œì‹œë¨ -->
                        <ellipse cx="50%" cy="50%" rx="28%" ry="46%" style="fill:none;stroke:#e74c3c;stroke-width:3;stroke-dasharray:7 5"/>
                    </svg>
                </div>
                <div style="
                    position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
                    background:#fff; border-radius:18px; padding:6px 18px; font-size:0.98em; color:#222; box-shadow:0 2px 8px #0001; z-index:3;">
                    ì¹´ë©”ë¼ë¥¼ ì •ë©´ìœ¼ë¡œ ë°”ë¼ë´ ì£¼ì„¸ìš”
                </div>
            </div>
            <div class="center">
                <button class="btn" onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
            </div>
        </div>

        <!-- í† í° ê¸°ë°˜ ì–¼êµ´ ë“±ë¡ -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ”‘</span>í† í°ìœ¼ë¡œ ì–¼êµ´ ë“±ë¡</div>
            <span class="sub-label">Access tokenì„ ì…ë ¥í•˜ê³ , ì¹´ë©”ë¼ë¡œ ì–¼êµ´ì„ ìº¡ì²˜í•œ ë’¤ ë“±ë¡í•˜ì„¸ìš”.</span>
            <div class="input-row">
                <input type="text" id="register_token" placeholder="Access Token ì…ë ¥" />
                <button class="btn" onclick="registerFaceWithJwtToken()">ë“±ë¡</button>
            </div>
        </div>

        <!-- ì–¼êµ´ ì¸ì¦ -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ›¡ï¸</span>ì–¼êµ´ ì¸ì¦</div>
            <div class="input-row">
                <input type="number" id="verify_ticket_id" placeholder="ì¸ì¦í•  í‹°ì¼“ ID" />
                <button class="btn" onclick="verifyFace()">ì¸ì¦</button>
            </div>
        </div>

        <!-- ë“±ë¡ëœ ì–¼êµ´ ëª©ë¡ -->
        <div class="section">
            <div class="section-title"><span class="icon">ğŸ“„</span>ë“±ë¡ëœ ì–¼êµ´ ëª©ë¡</div>
            <div class="center">
                <button class="btn" onclick="loadFaceList()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <ul id="face-list"></ul>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let stream = null;
        let registeredFace = null;

        // [ì¹´ë©”ë¼ ì‹œì‘] ë²„íŠ¼ í´ë¦­ ì‹œ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ì— ì—°ê²°
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('video').srcObject = stream;
                showResult('ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                showResult('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            }
        }

        // [ì–¼êµ´ ë“±ë¡] ë²„íŠ¼ í´ë¦­ ì‹œ: ê°€ì´ë“œë¼ì¸ ì²´í¬ í›„, í† í°ì—ì„œ user_id ì¶”ì¶œ, ìº¡ì²˜, ì„œë²„ë¡œ ë“±ë¡ ìš”ì²­
        async function registerFaceWithJwtToken() {
            await checkFaceInEllipse();
            if (!faceInEllipse) {
                showResult('ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const token = document.getElementById('register_token').value;
            if (!token) {
                showResult('Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            const payload = parseJwt(token); // [JWT íŒŒì‹±] user_id ì¶”ì¶œ
            if (!payload || !payload.user_id) {
                showResult('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.', 'error');
                return;
            }
            const userId = payload.user_id;
            // [ì–¼êµ´ ì´ë¯¸ì§€ ìº¡ì²˜]
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
            // ë“±ë¡í•  ticket_idëŠ” ì¸ì¦ìš© ì…ë ¥ë€ì—ì„œ ê°€ì ¸ì˜´
            const ticketId = document.getElementById('verify_ticket_id').value;
            if (!ticketId) {
                showResult('ì¸ì¦í•  í‹°ì¼“ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            registerFaceToServerWithUserAndTicket(imageData, userId, ticketId, token);
        }

        // [ì–¼êµ´ ë“±ë¡ ìš”ì²­] ì„œë²„ì— ì–¼êµ´ ì´ë¯¸ì§€, user_id, ticket_id, í† í°ì„ ì „ì†¡
        async function registerFaceToServerWithUserAndTicket(imageData, userId, ticketId, token) {
            try {
                const response = await fetch('/api/v1/tickets/face-recognition/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        image: imageData,
                        ticket_id: ticketId,
                        action: 'register'
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showResult('í† í° ê¸°ë°˜ ì–¼êµ´ ë“±ë¡ ì„±ê³µ!<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'success');
                } else {
                    showResult('í† í° ê¸°ë°˜ ì–¼êµ´ ë“±ë¡ ì‹¤íŒ¨: ' + result.message + '<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'error');
                }
            } catch (err) {
                showResult('ì„œë²„ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        // [ì–¼êµ´ ì¸ì¦] ë²„íŠ¼ í´ë¦­ ì‹œ: ê°€ì´ë“œë¼ì¸ ì²´í¬ í›„, í† í°ì—ì„œ user_id ì¶”ì¶œ, ìº¡ì²˜, ì„œë²„ë¡œ ì¸ì¦ ìš”ì²­
        async function verifyFace() {
            await checkFaceInEllipse();
            if (!faceInEllipse) {
                showResult('ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const ticketId = document.getElementById('verify_ticket_id').value;
            if (!ticketId) {
                showResult('ì¸ì¦í•  í‹°ì¼“ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg').split(',')[1];

            // í† í°ì—ì„œ user_id ì¶”ì¶œ
            const tokenInput = document.getElementById('register_token');
            const token = (tokenInput && tokenInput.value) ? tokenInput.value : '';
            const payload = parseJwt(token);
            if (!payload || !payload.user_id) {
                showResult('ìœ íš¨í•œ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            const userId = payload.user_id;

            try {
                const response = await fetch('/api/v1/tickets/face-recognition/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        image: imageData,
                        ticket_id: ticketId,
                        action: 'verify'
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showResult('ì–¼êµ´ ì¸ì¦ ê²°ê³¼:<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'success');
                } else {
                    showResult('ì–¼êµ´ ì¸ì¦ ì‹¤íŒ¨:<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'error');
                }
            } catch (err) {
                showResult('ì„œë²„ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }

        // [ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥] ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // [ë“±ë¡ëœ ì–¼êµ´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°] ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì—ì„œ ëª©ë¡ ì¡°íšŒ
        async function loadFaceList() {
            const listEl = document.getElementById('face-list');
            listEl.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const tokenInput = document.getElementById('register_token');
                const token = (tokenInput && tokenInput.value) ? tokenInput.value : '';
                const response = await fetch('/api/v1/tickets/face-list/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });
                const result = await response.json();
                if (response.ok && result.data) {
                    if (result.data.length === 0) {
                        listEl.innerHTML = '<li>ë“±ë¡ëœ ì–¼êµ´ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    } else {
                        listEl.innerHTML = '';
                        result.data.forEach(face => {
                            const li = document.createElement('li');
                            li.innerHTML = `${face.ExternalImageId} <button class='btn' style='padding:4px 10px;font-size:12px;' onclick="deleteFace('${face.FaceId}')">ì‚­ì œ</button>`;
                            listEl.appendChild(li);
                        });
                    }
                } else {
                    listEl.innerHTML = '<li>ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>';
                }
            } catch (err) {
                listEl.innerHTML = '<li>ì„œë²„ ì˜¤ë¥˜: ' + err.message + '</li>';
            }
        }

        // [ì–¼êµ´ ì‚­ì œ] ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— ì‚­ì œ ìš”ì²­
        async function deleteFace(faceId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                const tokenInput = document.getElementById('register_token');
                const token = (tokenInput && tokenInput.value) ? tokenInput.value : '';
                const response = await fetch('/api/v1/tickets/face-delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ face_id: faceId })
                });
                const result = await response.json();
                if (response.ok) {
                    alert('ì‚­ì œ ì„±ê³µ!');
                    loadFaceList();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (err) {
                alert('ì„œë²„ ì˜¤ë¥˜: ' + err.message);
            }
        }

        // [ë¡œê·¸ì¸] ë²„íŠ¼ í´ë¦­ ì‹œ: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸, í† í° ìë™ ì…ë ¥ ë° ë³µì‚¬ UI
        async function login() {
            const email = document.getElementById('login_email').value;
            const password = document.getElementById('login_password').value;
            if (!email || !password) {
                showLoginResult('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            try {
                const response = await fetch('/api/v1/user/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                if (response.ok) {
                    let token = result.token || result.access || result.key || '';
                    showLoginResult('ë¡œê·¸ì¸ ì„±ê³µ!<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'success');
                    if (token) {
                        document.getElementById('register_token').value = token;
                        document.getElementById('token_box').style.display = '';
                        document.getElementById('token_box').innerHTML = 'Access Token:<br>' + token + '<br><button onclick="copyToken()" class="btn" style="margin-top:6px;">ë³µì‚¬</button>';
                    }
                } else {
                    showLoginResult('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (result.message || JSON.stringify(result)), 'error');
                }
            } catch (err) {
                showLoginResult('ì„œë²„ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }
        // [ë¡œê·¸ì¸ ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥]
        function showLoginResult(message, type) {
            const resultDiv = document.getElementById('login_result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        // [íšŒì›ê°€ì…] ë²„íŠ¼ í´ë¦­ ì‹œ: ì…ë ¥ê°’ ê²€ì¦ í›„ ì„œë²„ì— íšŒì›ê°€ì… ìš”ì²­
        async function signup() {
            const email = document.getElementById('signup_email').value;
            const password = document.getElementById('signup_password').value;
            const password2 = document.getElementById('signup_password2').value;
            const name = document.getElementById('signup_name').value;
            const phone = document.getElementById('signup_phone').value;
            if (!email || !password || !password2 || !name || !phone) {
                showSignupResult('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (password !== password2) {
                showSignupResult('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            try {
                const response = await fetch('/api/v1/user/signup/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        password2,
                        name,
                        phone
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showSignupResult('íšŒì›ê°€ì… ì„±ê³µ!<br><pre>' + JSON.stringify(result, null, 2) + '</pre>', 'success');
                } else {
                    showSignupResult('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + (result.message || JSON.stringify(result)), 'error');
                }
            } catch (err) {
                showSignupResult('ì„œë²„ ì˜¤ë¥˜: ' + err.message, 'error');
            }
        }
        // [íšŒì›ê°€ì… ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥]
        function showSignupResult(message, type) {
            const resultDiv = document.getElementById('signup_result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
        // [í† í° ë³µì‚¬] ë²„íŠ¼ í´ë¦­ ì‹œ í´ë¦½ë³´ë“œì— í† í° ë³µì‚¬
        function copyToken() {
            const token = document.getElementById('register_token').value;
            if (token) {
                navigator.clipboard.writeText(token);
                alert('í† í°ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // [JWT íŒŒì‹±] í† í°ì—ì„œ user_id ì¶”ì¶œ (base64 ë””ì½”ë”©)
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }
    </script>
    <!-- 1. face-api.js CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- 2. ë‚´ JS ì½”ë“œ (defer í•„ìˆ˜) -->
    <script defer>
    let faceInEllipse = false;

    // [ì–¼êµ´ ê°€ì´ë“œë¼ì¸ ì²´í¬] ì–¼êµ´ ì¤‘ì‹¬ì´ ì¸ì‹ íƒ€ì›(ê°€ì´ë“œë¼ì¸ë³´ë‹¤ ë” ì‘ì€ íƒ€ì›) ì•ˆì— ì™„ì „íˆ ë“¤ì–´ì™€ì•¼ true
    async function checkFaceInEllipse() {
        const video = document.getElementById('video');
        if (!video || video.readyState !== 4) {
            faceInEllipse = false;
            return;
        }
        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
        if (!detections) {
            faceInEllipse = false;
            return;
        }
        const box = detections.box;
        const faceCenterX = box.x + box.width / 2;
        const faceCenterY = box.y + box.height / 2;
        const videoW = video.videoWidth;
        const videoH = video.videoHeight;
        const ellipseCX = videoW / 2;
        const ellipseCY = videoH / 2;
        // [ì‹¤ì œ ì¸ì‹ íƒ€ì›] ê°€ì´ë“œë¼ì¸ë³´ë‹¤ ë” ì‘ê²Œ ì„¤ì • (ë¹¡ë¹¡í•˜ê²Œ)
        const rx = videoW * 0.12; // ê¸°ì¡´ 0.36 â†’ 0.12
        const ry = videoH * 0.20; // ê¸°ì¡´ 0.46 â†’ 0.20
        const normX = (faceCenterX - ellipseCX) / rx;
        const normY = (faceCenterY - ellipseCY) / ry;
        faceInEllipse = (normX * normX + normY * normY) <= 1;
    }

    // [ëª¨ë¸ ë¡œë“œ ë° ì£¼ê¸°ì  ì–¼êµ´ ìœ„ì¹˜ ì²´í¬] í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ ë¡œë“œ, 0.7ì´ˆë§ˆë‹¤ ì²´í¬
    window.addEventListener('DOMContentLoaded', async function() {
        await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
        setInterval(checkFaceInEllipse, 700);
    });

    // ë°˜ë“œì‹œ ì‹¤ì œ ì½”ë“œë¡œ í•¨ìˆ˜ ì„ ì–¸!
    async function registerFaceWithJwtToken() {
        await checkFaceInEllipse();
        if (!faceInEllipse) {
            alert('ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”.');
            return;
        }
        const token = document.getElementById('register_token').value;
        if (!token) {
            alert('Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        const payload = parseJwt(token);
        if (!payload || !payload.user_id) {
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.');
            return;
        }
        const userId = payload.user_id;
        // ì–¼êµ´ ì´ë¯¸ì§€ ìº¡ì²˜
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
        // ë“±ë¡í•  ticket_idëŠ” ì¸ì¦ìš© ì…ë ¥ë€ì—ì„œ ê°€ì ¸ì˜´
        const ticketId = document.getElementById('verify_ticket_id').value;
        if (!ticketId) {
            alert('ì¸ì¦í•  í‹°ì¼“ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        registerFaceToServerWithUserAndTicket(imageData, userId, ticketId, token);
    }

    async function registerFaceToServerWithUserAndTicket(imageData, userId, ticketId, token) {
        try {
            const response = await fetch('/api/v1/tickets/face-recognition/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    image: imageData,
                    ticket_id: ticketId,
                    action: 'register'
                })
            });
            const result = await response.json();
            if (response.ok) {
                alert('í† í° ê¸°ë°˜ ì–¼êµ´ ë“±ë¡ ì„±ê³µ!<br><pre>' + JSON.stringify(result, null, 2) + '</pre>');
            } else {
                alert('í† í° ê¸°ë°˜ ì–¼êµ´ ë“±ë¡ ì‹¤íŒ¨: ' + result.message + '<br><pre>' + JSON.stringify(result, null, 2) + '</pre>');
            }
        } catch (err) {
            alert('ì„œë²„ ì˜¤ë¥˜: ' + err.message);
        }
    }

    async function verifyFace() {
        await checkFaceInEllipse();
        if (!faceInEllipse) {
            alert('ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”.');
            return;
        }
        const ticketId = document.getElementById('verify_ticket_id').value;
        if (!ticketId) {
            alert('ì¸ì¦í•  í‹°ì¼“ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg').split(',')[1];

        // í† í°ì—ì„œ user_id ì¶”ì¶œ
        const tokenInput = document.getElementById('register_token');
        const token = (tokenInput && tokenInput.value) ? tokenInput.value : '';
        const payload = parseJwt(token);
        if (!payload || !payload.user_id) {
            alert('ìœ íš¨í•œ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        const userId = payload.user_id;

        try {
            const response = await fetch('/api/v1/tickets/face-recognition/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    image: imageData,
                    ticket_id: ticketId,
                    action: 'verify'
                })
            });
            const result = await response.json();
            if (response.ok) {
                alert('ì–¼êµ´ ì¸ì¦ ê²°ê³¼:<br><pre>' + JSON.stringify(result, null, 2) + '</pre>');
            } else {
                alert('ì–¼êµ´ ì¸ì¦ ì‹¤íŒ¨:<br><pre>' + JSON.stringify(result, null, 2) + '</pre>');
            }
        } catch (err) {
            alert('ì„œë²„ ì˜¤ë¥˜: ' + err.message);
        }
    }

    // ê¸°íƒ€ í•¨ìˆ˜ë“¤ë„ ë§ˆì°¬ê°€ì§€ë¡œ ì‹¤ì œ ì½”ë“œë¡œ ì„ ì–¸
    </script>
</body>
</html>
